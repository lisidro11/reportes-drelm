<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Mapa IIEE – Lima Metropolitana</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- MarkerCluster (para 16k puntos sin colgar) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <style>
    html, body { height:100%; margin:0; font-family: Arial, sans-serif; }
    #map { height:100%; width:100%; }

    .panel {
      position:absolute; z-index:999; top:10px; left:10px;
      background:#fff; border-radius:12px; padding:12px 12px 10px 12px;
      box-shadow:0 10px 30px rgba(0,0,0,.18);
      width:320px; box-sizing:border-box;
    }
    .panel h3{ margin:0 0 8px 0; font-size:16px; }
    .row{ margin-bottom:8px; }
    label{ display:block; font-size:12px; color:#333; margin:0 0 4px 2px; }
    input, select, button{
      width:100%; padding:10px; border-radius:10px;
      border:1px solid #cfcfcf; box-sizing:border-box;
      font-size:13px;
    }
    .grid2{ display:grid; grid-template-columns:1fr 1fr; gap:8px; }
    .grid2 .row{ margin:0; }
    .actions{ display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-top:8px; }
    .small{ font-size:12px; color:#555; margin-top:8px; }
    .count{ font-weight:bold; }
  </style>
</head>

<body>
  <div id="map"></div>

  <div class="panel">
    <h3>Filtros IIEE</h3>

    <div class="row">
      <label>Buscar IE (nombre)</label>
      <input id="qNombre" list="listaIE" placeholder="Escribe y elige de la lista...">
      <datalist id="listaIE"></datalist>
    </div>

    <div class="row">
      <label>UGEL</label>
      <select id="fUGEL"></select>
    </div>

    <div class="grid2">
      <div class="row">
        <label>Distrito</label>
        <select id="fDistrito"></select>
      </div>
      <div class="row">
        <label>Modalidad</label>
        <select id="fModalidad"></select>
      </div>
    </div>

    <div class="small">
      IIEE mostradas: <span class="count" id="nCount">0</span>
    </div>

    <div class="actions">
      <button id="btnLimpiar">Limpiar</button>
      <button id="btnZoom">Zoom a filtros</button>
    </div>
  </div>

<script>
/* =========================
   0) AJUSTA AQUÍ LOS NOMBRES DE CAMPOS SI TU JSON USA OTROS
   ========================= */
// Tu JSON debe tener lat/lon y campos de texto.
// Si tu JSON tiene otros nombres (ej. "LATITUD", "LONGITUD", "DISTRITO", etc.), mapea aquí:
const KEYS = {
  nombre:  ["NOMBRE_IE","NOMBRE","NOM_IE","NOMIIEE","IE","nombre","nombre_ie"],
  ugel:    ["UGEL","ugel","UGEL_NOMBRE","UGEL_DESC"],
  distrito:["DISTRITO","distrito","DIST","DIST_DESC"],
  modalidad:["MODALIDAD","modalidad","MOD","MODAL_DESC"],
  codmod:  ["COD_MOD","codmod","CODIGO_MODULAR","COD_MODULAR"],
  lat:     ["LAT","lat","LATITUD","Latitud","Y"],
  lon:     ["LON","lon","LONGITUD","Longitud","X"]
};

function pick(obj, candidates){
  for (const k of candidates){
    if (obj[k] !== undefined && obj[k] !== null && String(obj[k]).trim() !== "") return obj[k];
  }
  return null;
}

function normRow(r){
  const lat = Number(pick(r, KEYS.lat));
  const lon = Number(pick(r, KEYS.lon));
  return {
    nombre:   String(pick(r, KEYS.nombre) ?? "").trim(),
    ugel:     String(pick(r, KEYS.ugel) ?? "").trim(),
    distrito: String(pick(r, KEYS.distrito) ?? "").trim(),
    modalidad:String(pick(r, KEYS.modalidad) ?? "").trim(),
    codmod:   String(pick(r, KEYS.codmod) ?? "").trim(),
    lat, lon
  };
}

function isValidCoord(x){ return Number.isFinite(x) && Math.abs(x) > 0.0001; }

/* =========================
   1) MAPA BASE (calles más “modernas”)
   ========================= */
const map = L.map('map', { preferCanvas: true }).setView([-12.0464, -77.0428], 11);

L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
  attribution: '&copy; OpenStreetMap & CARTO',
  subdomains: 'abcd',
  maxZoom: 19
}).addTo(map);

/* =========================
   2) CAPA DE PUNTOS (con cluster para performance)
   ========================= */
const cluster = L.markerClusterGroup({
  chunkedLoading: true,
  spiderfyOnMaxZoom: true,
  showCoverageOnHover: false
});
map.addLayer(cluster);

// Colores por UGEL (si no coincide, usa gris)
const COLOR_UGEL = {
  "UGEL 01": "#d32f2f",
  "UGEL 02": "#7b1fa2",
  "UGEL 03": "#1976d2",
  "UGEL 04": "#0097a7",
  "UGEL 05": "#388e3c",
  "UGEL 06": "#f57c00",
  "UGEL 07": "#5d4037"
};

// Marcador tipo “muñequito” (círculo grande en DivIcon, más ligero que imagen)
function makeIcon(color){
  return L.divIcon({
    className: "",
    html: `<div style="
      width:16px;height:16px;border-radius:50%;
      background:${color}; border:2px solid #fff;
      box-shadow:0 2px 10px rgba(0,0,0,.25);
    "></div>`,
    iconSize: [16,16],
    iconAnchor: [8,8]
  });
}

/* =========================
   3) UI
   ========================= */
const qNombre   = document.getElementById("qNombre");
const fUGEL     = document.getElementById("fUGEL");
const fDistrito = document.getElementById("fDistrito");
const fModalidad= document.getElementById("fModalidad");
const listaIE   = document.getElementById("listaIE");
const nCount    = document.getElementById("nCount");
const btnLimpiar= document.getElementById("btnLimpiar");
const btnZoom   = document.getElementById("btnZoom");

function setOptions(select, values, keep="Todos"){
  const prev = select.value;
  select.innerHTML = "";
  const optAll = document.createElement("option");
  optAll.value = "Todos";
  optAll.textContent = "Todos";
  select.appendChild(optAll);

  values.forEach(v=>{
    const o=document.createElement("option");
    o.value=v; o.textContent=v;
    select.appendChild(o);
  });

  // intenta mantener selección previa si aún existe
  if ([...select.options].some(o=>o.value===prev)) select.value=prev;
  else select.value="Todos";
}

/* =========================
   4) DATA + FILTROS EN CASCADA
   ========================= */
let DATA = [];         // normalizada
let MARKERS = [];      // {row, marker}
let lastFiltered = []; // rows filtradas

fetch("iiee_lm.json")
  .then(r => r.json())
  .then(raw => {
    // raw puede ser array o {data:[...]}
    const arr = Array.isArray(raw) ? raw : (raw.data || raw.features || []);
    DATA = arr.map(normRow).filter(x =>
      isValidCoord(x.lat) && isValidCoord(x.lon) && x.nombre
    );

    // poblar filtros base
    const ugels = [...new Set(DATA.map(d=>d.ugel).filter(Boolean))].sort();
    setOptions(fUGEL, ugels);

    // datalist de IE (autocompletar)
    // (si son muchas, igual funciona; si quieres lo limitamos)
    const frag = document.createDocumentFragment();
    DATA.forEach(d=>{
      const opt=document.createElement("option");
      opt.value = d.nombre;
      frag.appendChild(opt);
    });
    listaIE.appendChild(frag);

    // construir markers (una sola vez)
    buildMarkers(DATA);

    // inicializar cascada y pintar
    refreshCascades();
    applyFilters();
  })
  .catch(err => {
    alert("No se pudo leer iie_lm.json. Verifica que el archivo esté en la raíz del repo.");
    console.error(err);
  });

function buildMarkers(rows){
  cluster.clearLayers();
  MARKERS = [];

  rows.forEach(d=>{
    const c = COLOR_UGEL[d.ugel] || "#ff9800";
    const m = L.marker([d.lat, d.lon], { icon: makeIcon(c) });

    const popup = `
      <b>${escapeHtml(d.nombre)}</b><br>
      <b>UGEL:</b> ${escapeHtml(d.ugel)}<br>
      <b>Distrito:</b> ${escapeHtml(d.distrito)}<br>
      <b>Modalidad:</b> ${escapeHtml(d.modalidad)}<br>
      ${d.codmod ? `<b>Código modular:</b> ${escapeHtml(d.codmod)}<br>` : ""}
      <span style="font-size:12px;color:#666">(${d.lat.toFixed(6)}, ${d.lon.toFixed(6)})</span>
    `;
    m.bindPopup(popup);

    MARKERS.push({ row:d, marker:m });
  });

  // No se añade todo aquí; applyFilters decide qué se muestra
}

function refreshCascades(){
  const ugelSel = fUGEL.value;

  // distritos posibles según UGEL
  let base = DATA;
  if (ugelSel !== "Todos") base = base.filter(d => d.ugel === ugelSel);

  const distritos = [...new Set(base.map(d=>d.distrito).filter(Boolean))].sort();
  setOptions(fDistrito, distritos);

  // modalidades posibles según UGEL + Distrito
  const distSel = fDistrito.value;
  let base2 = base;
  if (distSel !== "Todos") base2 = base2.filter(d => d.distrito === distSel);

  const modalidades = [...new Set(base2.map(d=>d.modalidad).filter(Boolean))].sort();
  setOptions(fModalidad, modalidades);
}

function applyFilters(){
  const q = qNombre.value.trim().toLowerCase();
  const ugelSel = fUGEL.value;
  const distSel = fDistrito.value;
  const modSel  = fModalidad.value;

  // filtrar rows
  lastFiltered = DATA.filter(d=>{
    if (ugelSel !== "Todos" && d.ugel !== ugelSel) return false;
    if (distSel !== "Todos" && d.distrito !== distSel) return false;
    if (modSel  !== "Todos" && d.modalidad !== modSel) return false;
    if (q && !d.nombre.toLowerCase().includes(q)) return false;
    return true;
  });

  nCount.textContent = lastFiltered.length.toLocaleString("es-PE");

  // mostrar solo marcadores filtrados
  cluster.clearLayers();
  // optimización: solo agrega markers que cumplan
  const setFiltered = new Set(lastFiltered);
  MARKERS.forEach(({row, marker})=>{
    if (setFiltered.has(row)) cluster.addLayer(marker);
  });
}

function zoomToFiltered(){
  if (!lastFiltered.length) return;
  const bounds = L.latLngBounds(lastFiltered.map(d => [d.lat, d.lon]));
  map.fitBounds(bounds.pad(0.15));
}

function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, m => ({
    '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'
  }[m]));
}

/* =========================
   5) EVENTOS
   ========================= */
fUGEL.addEventListener("change", ()=>{
  refreshCascades();
  applyFilters();
});

fDistrito.addEventListener("change", ()=>{
  refreshCascades();
  applyFilters();
});

fModalidad.addEventListener("change", ()=>{
  applyFilters();
});

qNombre.addEventListener("input", ()=>{
  // si escribe rápido, filtra; si elige una IE exacta, hacemos zoom a esa
  applyFilters();

  const exact = DATA.find(d => d.nombre.toLowerCase() === qNombre.value.trim().toLowerCase());
  if (exact){
    // zoom + popup
    map.setView([exact.lat, exact.lon], 16);
    // abrir popup del marker correspondiente
    const hit = MARKERS.find(x => x.row === exact);
    if (hit){
      cluster.zoomToShowLayer(hit.marker, ()=> hit.marker.openPopup());
    }
  }
});

btnLimpiar.addEventListener("click", ()=>{
  qNombre.value = "";
  fUGEL.value = "Todos";
  refreshCascades();
  fDistrito.value = "Todos";
  fModalidad.value = "Todos";
  applyFilters();
  map.setView([-12.0464, -77.0428], 11);
});

btnZoom.addEventListener("click", zoomToFiltered);
</script>

</body>
</html>

