<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<title>Mapa IIEE – Lima Metropolitana</title>

<script src="https://cdn.jsdelivr.net/npm/deck.gl@8.9.27/dist.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@deck.gl/layers@8.9.27/dist.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/maplibre-gl@2.4.0/dist/maplibre-gl.js"></script>
<link href="https://cdn.jsdelivr.net/npm/maplibre-gl@2.4.0/dist/maplibre-gl.css" rel="stylesheet" />

<style>
  body { margin:0; font-family: Arial, sans-serif; }
  #map { position:absolute; inset:0; }

  .panel {
    position:absolute;
    top:12px;
    left:12px;
    background:white;
    padding:12px;
    border-radius:12px;
    box-shadow:0 4px 14px rgba(0,0,0,0.20);
    width:280px;
    z-index:10;
  }
  .panel h3 { margin:0 0 10px; font-size:16px; }
  .panel input, .panel select {
    width:100%;
    padding:8px;
    margin-bottom:8px;
    border-radius:8px;
    border:1px solid #cfcfcf;
    outline:none;
  }
  .panel small { color:#666; display:block; margin-top:4px; }
</style>
</head>

<body>
<div id="map"></div>

<div class="panel">
  <h3>Filtros IIEE</h3>
  <input id="buscar" placeholder="Buscar IE..." />
  <select id="ugel"></select>
  <select id="distrito"></select>
  <select id="modalidad"></select>
  <small id="contador"></small>
</div>

<script>
(async function () {
  const ugelSel = document.getElementById("ugel");
  const distSel = document.getElementById("distrito");
  const modSel  = document.getElementById("modalidad");
  const buscar  = document.getElementById("buscar");
  const contador = document.getElementById("contador");

  // ✅ importante: mismo folder que el html
  const resp = await fetch("./iiee_lm.json");
  const data0 = await resp.json();

  // Normaliza y filtra solo registros válidos
  const data = data0
    .map(d => ({
      ...d,
      ie: (d.ie ?? "").toString(),
      ugel: (d.ugel ?? "").toString(),
      distrito: (d.distrito ?? "").toString(),
      modalidad: (d.modalidad ?? "").toString(),
      lat: Number(d.lat),
      lon: Number(d.lon)
    }))
    .filter(d => Number.isFinite(d.lat) && Number.isFinite(d.lon) && d.ie.length > 0);

  function setOptions(select, campo) {
    const vals = [...new Set(data.map(d => d[campo]).filter(v => v && v.trim().length > 0))].sort();
    select.innerHTML = `<option value="">Todos</option>` + vals.map(v => `<option value="${escapeHtml(v)}">${escapeHtml(v)}</option>`).join("");
  }

  function escapeHtml(s){
    return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;");
  }

  setOptions(ugelSel, "ugel");
  setOptions(distSel, "distrito");
  setOptions(modSel, "modalidad");

  const deckgl = new deck.DeckGL({
    container: "map",
    mapStyle: "https://basemaps.cartocdn.com/gl/positron-gl-style/style.json",
    initialViewState: { longitude: -77.0428, latitude: -12.0464, zoom: 10, pitch: 0, bearing: 0 },
    controller: true,
    getTooltip: ({object}) => object ? {
      html: `
        <b>${escapeHtml(object.ie)}</b><br>
        UGEL: ${escapeHtml(object.ugel)}<br>
        Distrito: ${escapeHtml(object.distrito)}<br>
        Modalidad: ${escapeHtml(object.modalidad)}<br>
        ${object.cod_mod ? `CodMod: ${escapeHtml(object.cod_mod)}<br>` : ""}
        ${object.direccion ? `Dir: ${escapeHtml(object.direccion)}` : ""}
      `
    } : null
  });

  function filtrar() {
    const u = ugelSel.value;
    const di = distSel.value;
    const mo = modSel.value;
    const tx = buscar.value.trim().toLowerCase();

    const out = data.filter(d =>
      (!u  || d.ugel === u) &&
      (!di || d.distrito === di) &&
      (!mo || d.modalidad === mo) &&
      (!tx || d.ie.toLowerCase().includes(tx))
    );

    contador.textContent = `IIEE mostradas: ${out.length.toLocaleString("es-PE")}`;

    const layer = new deck.ScatterplotLayer({
      id: "iiee-layer",
      data: out,
      getPosition: d => [d.lon, d.lat],
      getRadius: 18,
      radiusUnits: "meters",
      getFillColor: [255, 140, 0, 180],
      getLineColor: [0, 0, 0, 60],
      lineWidthMinPixels: 1,
      pickable: true
    });

    deckgl.setProps({ layers: [layer] });
  }

  ugelSel.onchange = filtrar;
  distSel.onchange = filtrar;
  modSel.onchange = filtrar;
  buscar.oninput = filtrar;

  filtrar();
})();
</script>
</body>
</html>
