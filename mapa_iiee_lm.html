<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mapa IIEE – Lima Metropolitana</title>

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <style>
    :root{
      --azul:#003366;
      --panel:#ffffff;
      --borde:#d9d9d9;
      --sombra: 0 10px 25px rgba(0,0,0,.12);
      --radio: 14px;
    }
    body{ margin:0; font-family: Arial, sans-serif; background:#f5f7fa; }
    #wrap{ height:100vh; width:100vw; position:relative; }

    /* Mapa ocupa todo */
    #map{ height:100%; width:100%; }

    /* Panel flotante filtros */
    .panel{
      position:absolute;
      top:14px;
      left:360px;              /* ojo: tu visor tiene sidebar a la izquierda, por eso lo movemos */
      width:320px;
      background:var(--panel);
      border:1px solid var(--borde);
      border-radius: var(--radio);
      box-shadow: var(--sombra);
      padding:12px 12px 10px;
      z-index: 1000;
    }
    .panel h3{
      margin:0 0 8px;
      font-size:16px;
      font-weight:700;
    }
    .row{ display:grid; gap:8px; margin-bottom:8px; }
    .row-2{ grid-template-columns: 1fr 1fr; }
    label{ font-size:12px; color:#333; margin-bottom:4px; display:block; }
    input, select{
      width:100%;
      padding:9px 10px;
      border-radius:10px;
      border:1px solid #cfcfcf;
      outline:none;
      font-size:13px;
      background:#fff;
    }
    input:focus, select:focus{ border-color:#7aa7d6; box-shadow:0 0 0 3px rgba(122,167,214,.22); }

    .btns{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:8px;
      margin-top:8px;
    }
    button{
      border:1px solid #cfcfcf;
      background:#fff;
      padding:9px 10px;
      border-radius:10px;
      cursor:pointer;
      font-size:13px;
    }
    button:hover{ background:#eef5ff; border-color:#b8d3f3; }
    .muted{ font-size:12px; color:#666; margin-top:8px; }

    /* caja sugerencias */
    .suggest{
      position:relative;
    }
    .listbox{
      position:absolute;
      top:62px;
      left:0;
      right:0;
      background:#fff;
      border:1px solid #cfcfcf;
      border-radius:12px;
      box-shadow: var(--sombra);
      max-height: 240px;
      overflow:auto;
      display:none;
      z-index:2000;
    }
    .item{
      padding:9px 10px;
      border-bottom:1px solid #f0f0f0;
      cursor:pointer;
      font-size:13px;
    }
    .item:hover{ background:#f4f9ff; }
    .item small{ color:#666; display:block; margin-top:2px; }

    /* contador */
    .count{
      font-size:12px;
      color:#444;
      margin-top:6px;
    }
  </style>
</head>

<body>
<div id="wrap">
  <div id="map"></div>

  <div class="panel">
    <h3>Filtros IIEE</h3>

    <div class="row suggest">
      <label for="q">Buscar IE (nombre)</label>
      <input id="q" placeholder="Escribe y elige de la lista…" autocomplete="off" />
      <div id="listbox" class="listbox"></div>
    </div>

    <div class="row">
      <label for="ugel">UGEL</label>
      <select id="ugel"></select>
    </div>

    <div class="row row-2">
      <div>
        <label for="distrito">Distrito</label>
        <select id="distrito"></select>
      </div>
      <div>
        <label for="modalidad">Modalidad</label>
        <select id="modalidad"></select>
      </div>
    </div>

    <div class="count" id="count">IIEE mostradas: 0</div>

    <div class="btns">
      <button id="btnClear">Limpiar</button>
      <button id="btnZoom">Zoom a filtros</button>
    </div>

    <div class="muted">
      * Si no carga al instante, refresca (Ctrl+F5) porque GitHub Pages demora en actualizar.
    </div>
  </div>
</div>

<script>
/** =============================
 *  CONFIG
 *  ============================= */
const DATA_URL = new URL("iiee_lm.json", window.location.href).toString(); // SIEMPRE correcto en GitHub Pages
const DEFAULT_CENTER = [-12.0464, -77.0428]; // Lima centro (aprox)
const DEFAULT_ZOOM = 11;

/** =============================
 *  UTILIDADES
 *  ============================= */
function norm(s){
  return (s ?? "")
    .toString()
    .trim()
    .toUpperCase();
}
function toNum(x){
  const v = Number(x);
  return Number.isFinite(v) ? v : null;
}
function uniqueSorted(arr){
  return Array.from(new Set(arr.filter(Boolean))).sort((a,b)=> a.localeCompare(b));
}
function setOptions(select, values, placeholder="Todos"){
  select.innerHTML = "";
  const opt0 = document.createElement("option");
  opt0.value = "";
  opt0.textContent = placeholder;
  select.appendChild(opt0);

  values.forEach(v=>{
    const o = document.createElement("option");
    o.value = v;
    o.textContent = v;
    select.appendChild(o);
  });
}

/** =============================
 *  MAPA (Leaflet)
 *  ============================= */
const map = L.map("map", {
  zoomControl: true,
  attributionControl: false, // para que NO salga la pantalla rara; ponemos atribución simple abajo
}).setView(DEFAULT_CENTER, DEFAULT_ZOOM);

// Base map (OSM / CARTO) - calles actualizadas
L.tileLayer("https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png", {
  maxZoom: 19,
  subdomains: "abcd"
}).addTo(map);

// Atribución simple
L.control.attribution({ position:"bottomright", prefix:false })
  .addAttribution('© OpenStreetMap | © CARTO')
  .addTo(map);

// Capa de puntos
let layerGroup = L.layerGroup().addTo(map);
let allData = [];      // dataset completo
let filtered = [];     // dataset filtrado actual

/** =============================
 *  ELEMENTOS UI
 *  ============================= */
const elQ = document.getElementById("q");
const elList = document.getElementById("listbox");
const elUGEL = document.getElementById("ugel");
const elDist = document.getElementById("distrito");
const elMod  = document.getElementById("modalidad");
const elCount= document.getElementById("count");
const btnClear = document.getElementById("btnClear");
const btnZoom  = document.getElementById("btnZoom");

/** =============================
 *  MAPEO DE CAMPOS
 *  (ajusta aquí si tus columnas tienen otro nombre)
 *  =============================
 *  Debes tener:
 *    - latitud, longitud
 *    - ugel
 *    - distrito
 *    - modalidad
 *    - nombre_ie (o similar)
 */
function pickRow(r){
  // OJO: si tu JSON tiene otros nombres, cámbialos aquí.
  const lat = toNum(r.latitud ?? r.LATITUD ?? r.lat ?? r.latitude);
  const lon = toNum(r.longitud ?? r.LONGITUD ?? r.lon ?? r.lng ?? r.longitude);

  return {
    raw: r,
    lat, lon,
    ugel: (r.ugel ?? r.UGEL ?? r.ugel_nombre ?? r.UGEL_NOMBRE ?? "").toString(),
    distrito: (r.distrito ?? r.DISTRITO ?? "").toString(),
    modalidad: (r.modalidad ?? r.MODALIDAD ?? r.d_modalidad ?? "").toString(),
    nombre: (r.nombre_ie ?? r.NOMBRE_IE ?? r.cen_edu ?? r.CEN_EDU ?? r.nombre ?? r.NOMBRE ?? "").toString(),
    codigo_mod: (r.cod_mod ?? r.COD_MOD ?? r.codigo_modular ?? r.CODIGO_MODULAR ?? "").toString(),
  };
}

/** =============================
 *  CARGA DATA
 *  ============================= */
(async function init(){
  try{
    const resp = await fetch(DATA_URL, { cache: "no-store" });
    if(!resp.ok) throw new Error("HTTP " + resp.status + " -> " + DATA_URL);

    const json = await resp.json();

    // Soporta: lista directa o {data:[...]}
    const rows = Array.isArray(json) ? json : (Array.isArray(json.data) ? json.data : null);
    if(!rows) throw new Error("El JSON no tiene formato esperado (lista o {data:[...]})");

    // Normaliza y filtra registros con lat/lon válidos
    allData = rows.map(pickRow).filter(x => x.lat !== null && x.lon !== null);

    // Poblar filtros
    const ugelList = uniqueSorted(allData.map(d => d.ugel));
    setOptions(elUGEL, ugelList, "Todos");

    // Inicial (dependientes)
    rebuildDependentFilters();

    // Pintar
    applyFilters({ doZoom:true });

    console.log("DATA OK:", allData.length, "registros", "URL:", DATA_URL);
  }catch(err){
    console.error(err);
    alert("No se pudo leer iiee_lm.json.\nRuta usada: " + DATA_URL + "\nDetalle: " + err.message);
  }
})();

/** =============================
 *  FILTROS DEPENDIENTES
 *  ============================= */
function rebuildDependentFilters(){
  const u = elUGEL.value;

  // base depende de UGEL
  const base = u ? allData.filter(d => d.ugel === u) : allData;

  // distrito y modalidad SOLO de la base
  const distList = uniqueSorted(base.map(d => d.distrito));
  const modList  = uniqueSorted(base.map(d => d.modalidad));

  // mantener selección previa si aún existe
  const prevDist = elDist.value;
  const prevMod  = elMod.value;

  setOptions(elDist, distList, "Todos");
  setOptions(elMod,  modList,  "Todos");

  if(prevDist && distList.includes(prevDist)) elDist.value = prevDist; else elDist.value = "";
  if(prevMod  && modList.includes(prevMod))   elMod.value  = prevMod;  else elMod.value  = "";
}

/** =============================
 *  APLICAR FILTROS Y DIBUJAR
 *  ============================= */
function applyFilters({doZoom=false} = {}){
  const u = elUGEL.value;
  const d = elDist.value;
  const m = elMod.value;

  filtered = allData.filter(r=>{
    if(u && r.ugel !== u) return false;
    if(d && r.distrito !== d) return false;
    if(m && r.modalidad !== m) return false;
    return true;
  });

  // Si escribió algo y eligió IE exacta (por lista), también filtra por nombre
  const q = norm(elQ.value);
  if(q && elQ.dataset.selected === "1"){
    filtered = filtered.filter(r => norm(r.nombre) === q);
  }

  drawPoints(filtered);
  elCount.textContent = "IIEE mostradas: " + filtered.length.toLocaleString("es-PE");

  if(doZoom) zoomTo(filtered);
}

function drawPoints(rows){
  layerGroup.clearLayers();

  // Puntos más visibles
  const markerStyle = {
    radius: 6,          // tamaño (sube a 7/8 si quieres más grande)
    weight: 1,
    opacity: 0.95,
    fillOpacity: 0.75
  };

  rows.forEach(r=>{
    // color por UGEL (para distinguir)
    const color = colorByUGEL(r.ugel);

    const mk = L.circleMarker([r.lat, r.lon], {
      ...markerStyle,
      color: "#1f1f1f",
      fillColor: color
    });

    const html =
      `<div style="font-family:Arial;font-size:13px;">
        <b>${escapeHtml(r.nombre || "Sin nombre")}</b><br/>
        <span><b>COD MOD:</b> ${escapeHtml(r.codigo_mod || "-")}</span><br/>
        <span><b>UGEL:</b> ${escapeHtml(r.ugel || "-")}</span><br/>
        <span><b>Distrito:</b> ${escapeHtml(r.distrito || "-")}</span><br/>
        <span><b>Modalidad:</b> ${escapeHtml(r.modalidad || "-")}</span>
      </div>`;

    mk.bindPopup(html, { maxWidth: 360 });
    mk.addTo(layerGroup);
  });
}

function zoomTo(rows){
  if(!rows || rows.length === 0){
    map.setView(DEFAULT_CENTER, DEFAULT_ZOOM);
    return;
  }
  const latlngs = rows.map(r => [r.lat, r.lon]);
  const bounds = L.latLngBounds(latlngs);
  map.fitBounds(bounds, { padding:[30,30] });
}

/** =============================
 *  BÚSQUEDA CON SUGERENCIAS
 *  ============================= */
function showSuggestions(items){
  elList.innerHTML = "";
  if(items.length === 0){
    elList.style.display = "none";
    return;
  }
  items.slice(0, 40).forEach(r=>{
    const div = document.createElement("div");
    div.className = "item";
    div.innerHTML = `
      <strong>${escapeHtml(r.nombre || "Sin nombre")}</strong>
      <small>${escapeHtml(r.ugel || "-")} | ${escapeHtml(r.distrito || "-")} | ${escapeHtml(r.modalidad || "-")}</small>
    `;
    div.addEventListener("click", ()=>{
      elQ.value = r.nombre;
      elQ.dataset.selected = "1"; // seleccionado de lista
      elList.style.display = "none";

      // Al elegir IE: ajusta filtros para que concuerden y haga zoom
      elUGEL.value = r.ugel || "";
      rebuildDependentFilters();
      elDist.value = r.distrito || "";
      elMod.value  = r.modalidad || "";

      applyFilters({ doZoom:true });
    });
    elList.appendChild(div);
  });
  elList.style.display = "block";
}

elQ.addEventListener("input", ()=>{
  elQ.dataset.selected = "0"; // escribe libre, aún no seleccionado
  const q = norm(elQ.value);

  if(q.length < 3){
    elList.style.display = "none";
    // no aplico filtro por nombre aún
    applyFilters({ doZoom:false });
    return;
  }

  // sugerencias dependen de filtros actuales (UGEL/Distr/Mod)
  const u = elUGEL.value;
  const d = elDist.value;
  const m = elMod.value;

  const base = allData.filter(r=>{
    if(u && r.ugel !== u) return false;
    if(d && r.distrito !== d) return false;
    if(m && r.modalidad !== m) return false;
    return true;
  });

  const hits = base.filter(r => norm(r.nombre).includes(q));
  showSuggestions(hits);
});

document.addEventListener("click", (e)=>{
  if(!elList.contains(e.target) && e.target !== elQ){
    elList.style.display = "none";
  }
});

/** =============================
 *  EVENTOS FILTROS
 *  ============================= */
elUGEL.addEventListener("change", ()=>{
  // al cambiar UGEL, reconstruye dependientes
  rebuildDependentFilters();
  // al cambiar UGEL, la búsqueda ya no es selección fija
  elQ.dataset.selected = "0";
  applyFilters({ doZoom:true });
});

elDist.addEventListener("change", ()=>{
  elQ.dataset.selected = "0";
  applyFilters({ doZoom:true });
});

elMod.addEventListener("change", ()=>{
  elQ.dataset.selected = "0";
  applyFilters({ doZoom:true });
});

btnClear.addEventListener("click", ()=>{
  elQ.value = "";
  elQ.dataset.selected = "0";
  elUGEL.value = "";
  rebuildDependentFilters();
  applyFilters({ doZoom:true });
});

btnZoom.addEventListener("click", ()=>{
  applyFilters({ doZoom:true });
});

/** =============================
 *  COLOR POR UGEL (simple)
 *  ============================= */
const ugelPalette = [
  "#1f77b4","#ff7f0e","#2ca02c","#d62728","#9467bd","#17becf","#bcbd22","#8c564b"
];
const ugelColorMap = new Map();
function colorByUGEL(ugel){
  const key = norm(ugel);
  if(!ugelColorMap.has(key)){
    ugelColorMap.set(key, ugelPalette[ugelColorMap.size % ugelPalette.length]);
  }
  return ugelColorMap.get(key);
}

/** =============================
 *  SEGURIDAD HTML
 *  ============================= */
function escapeHtml(s){
  return (s ?? "").toString()
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
</script>
</body>
</html>
